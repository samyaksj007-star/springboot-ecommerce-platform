<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/profileHeader.css" />
    <link rel="stylesheet" href="/css/profile.css" />
</head>
<body>

<header th:replace="profileHeader :: header1(${website})"></header>

<!-- Add Address Modal -->
<form th:action="@{/addressForm}" th:object="${address}" method="post">
<input type="hidden" th:field="*{id}" name="id" />
  <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content address-modal">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold" id="addAddressLabel">Add / Edit Address</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <!-- Default address checkbox -->
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" th:field="*{isPrimary}" id="isDefault">
            <label class="form-check-label" for="isDefault">This is my primary address</label>
          </div>

          <!-- Country -->
          <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <select class="form-select" id="country">
              <option selected>India</option>
            </select>
          </div>

          <!-- Name -->
          <div class="row mb-3">
            <div class="col-md-6">
              <input type="text" th:field="*{firstName}" class="form-control" placeholder="First name" required>
            </div>
            <div class="col-md-6">
              <input type="text" th:field="*{lastName}" class="form-control" placeholder="Last name" required>
            </div>
          </div>

          <!-- Address -->
          <div class="mb-3">
            <input type="text" th:field="*{addressLine}" class="form-control" placeholder="Address" required>
          </div>

          <!-- City, State, Pin -->
          <div class="row mb-3">
            <div class="col-md-4">
              <input type="text" th:field="*{city}" class="form-control" placeholder="City" required>
            </div>
            <div class="col-md-5">
              <input type="text" th:field="*{state}" class="form-control" placeholder="State" required>
            </div>
            <div class="col-md-3">
              <input type="text" th:field="*{postalCode}" class="form-control" placeholder="PIN code" required>
            </div>
          </div>

          <!-- Phone -->
          <div class="row mb-3">
            <div class="col-3">
              <select class="form-select">
                <option selected>+91</option>
              </select>
            </div>
            <div class="col-9">
              <input type="tel" th:field="*{phoneNumber}" class="form-control" placeholder="Phone number" required>
            </div>
          </div>

          <!-- Buttons -->
          <div class="d-flex justify-content-end mt-4">
            <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>

        </div>
      </div>
    </div>
  </div>
</form>

<div class="container py-5">
    <h2 class="fw-bold mb-4">Profile</h2>

    <!-- Profile Card -->
    <div class="card mb-4 p-4">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h5 class="fw-bold">
                    <span th:text="${name}"></span>
                    <i class="bi bi-pencil edit-icon ms-2"></i>
                </h5>
                <p class="text-muted mb-1">Email</p>
                <p class="mb-0" th:text="${email}"></p>
            </div>
        </div>
    </div>

    <!-- Addresses Card -->
    <div class="card p-4">
        <div class="d-flex justify-content-between mb-2">
            <h5 class="fw-bold">Addresses</h5>
            <span class="add-btn" data-bs-toggle="modal" data-bs-target="#addAddressModal">+ Add</span>
        </div>
        
        <!-- Error message -->
   	 	<div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

        <!-- Loop all addresses -->
        <div class="d-flex gap-4 flex-wrap">
        <!-- Show message if no address -->
	    <div th:if="${#lists.isEmpty(addresses)}" class="text-muted">
	        Add your address
	    </div>
	    
            <div th:each="addr : ${addresses}" class="border p-3 rounded" style="min-width: 250px;">
                <p class="text-muted mb-1" 
                   th:text="${addr.isPrimary} ? 'Default address' : 'Address'"></p>
                <p class="fw-bold mb-0" th:text="${addr.firstName} + ' ' + ${addr.lastName}"></p>
                <p th:text="${addr.addressLine}"></p>
                <p th:text="${addr.postalCode} + ' ' + ${addr.city} + ' ' + ${addr.state}"></p>
                <p>India</p>
                <p th:text="${addr.phoneNumber}"></p>

                <!-- Edit button -->
                <i class="bi bi-pencil edit-icon"
                   data-bs-toggle="modal"
                   data-bs-target="#addAddressModal"
                   th:attr="data-id=${addr.id},
                            data-firstname=${addr.firstName},
                            data-lastname=${addr.lastName},
                            data-address=${addr.addressLine},
                            data-city=${addr.city},
                            data-state=${addr.state},
                            data-postal=${addr.postalCode},
                            data-phone=${addr.phoneNumber},
                            data-primary=${addr.isPrimary}">
                </i>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    var addAddressModal = document.getElementById("addAddressModal");

    addAddressModal.addEventListener("show.bs.modal", function (event) {
        var button = event.relatedTarget;

        if (button && button.classList.contains("edit-icon")) {
        	// Set hidden ID
            addAddressModal.querySelector("input[name='id']").value = button.getAttribute("data-id") || "";
            
            // Fill modal with existing address
            addAddressModal.querySelector("input[placeholder='First name']").value = button.getAttribute("data-firstname") || "";
            addAddressModal.querySelector("input[placeholder='Last name']").value = button.getAttribute("data-lastname") || "";
            addAddressModal.querySelector("input[placeholder='Address']").value = button.getAttribute("data-address") || "";
            addAddressModal.querySelector("input[placeholder='City']").value = button.getAttribute("data-city") || "";
            addAddressModal.querySelector("input[placeholder='State']").value = button.getAttribute("data-state") || "";
            addAddressModal.querySelector("input[placeholder='PIN code']").value = button.getAttribute("data-postal") || "";
            addAddressModal.querySelector("input[placeholder='Phone number']").value = button.getAttribute("data-phone") || "";
            addAddressModal.querySelector("#isDefault").checked = button.getAttribute("data-primary") === "true";
        } else {
            // Clear on Add
            addAddressModal.querySelectorAll("input").forEach(input => input.value = "");
            addAddressModal.querySelector("#isDefault").checked = false;
        }
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
